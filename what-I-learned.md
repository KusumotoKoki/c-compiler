# What I Learned

## Chap01: [はじめに](https://www.sigbus.info/compilerbook#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB)

## Chap02: [機械語とアセンブラ](https://www.sigbus.info/compilerbook#%E6%A9%9F%E6%A2%B0%E8%AA%9E%E3%81%A8%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9)

### CPUとメモリ

> CPUが実行するプログラムと、そのプログラムが読み書きするデータは、どちらもメモリに入っています。CPUは「現在実行中の命令のアドレス」をCPU内部に保持していて、そのアドレスから命令を読み出して、そこに書かれていることを行い、そして次の命令を読み出して実行する、ということを行なっています。その現在実行中の命令のアドレスのことを「プログラムカウンタ」（PC）や「インストラクションポインタ」（IP）といいます。CPUが実行するプログラムの形式そのもののことを「機械語」(machine code)といいます。

> 特定の機械語の命令を総称として「命令セットアーキテクチャ」（instruction set architecture, ISA）あるいは「命令セット」といいます。

### 命令セットアーキテクチャ

- x86-64
	- 別名: AMD64, Intel 64, x64
	- 64bit
- x86
	- 32bit
- ARM64
	- 別名: AArch64
	- 64bit
- 32bitのARMアーキテクチャもある

- Linuxは，複数のCPUアーキテクチャをサポートしてる
- macOS (Intel) は x86-64 で macOS (M1, M2) は ARM64

### アセンブラ

> アセンブリは機械語にほぼそのまま1対1で対応するような言語なのですが、機械語よりもはるかに人間にとって読みやすいものになっています。

- アセンブリを機械語に変換するやつが「アセンブラ」

- 実際に，`$ objdump -d -M intel /bin/ls`でアセンブリが見れる
	- `objdump`: 機械語をアセンブリに逆アセンブルする
	- `/bin/ls`: 機械語で書かれているバイナリファイル
	- `-d`: 逆アセンブル（disassemble）をする
	- `-M intel`: Intel構文で

### Cとそれに対応するアセンブラ

Cプログラムの例
```test1.c
int main() {
  return 42;
}
```

これに対応するアセンブリプログラムを直接書いて`test2.s`という名前で保存する．
```test2.s
.intel_syntax noprefix
.globl main
main:
        mov rax, 42
        ret
```

次で実際にコンパイルできる．
```bash
$ cc -o test2 test2.s
```

> 整数を入れられるレジスタはRAXを含めて合計で16個あるのですが、関数からリターンしたときにRAXに入っている値が関数の返り値という約束になっている

> 大雑把にいうと、Cコンパイラは、`test1.c`のようなCコードを読み込んだ時に、`test2.s`のようなアセンブリを出力するプログラムということになります。

### 関数呼び出しを含む例

```test3.s
.intel_syntax noprefix
.globl plus, main

plus:
        add rsi, rdi
        mov rax, rsi
        ret

main:
        mov rdi, 3
        mov rsi, 4
        call plus
        ret
```

> `add`は足し算を行う命令です。この場合には、RSIレジスタとRDIレジスタを足した結果がRSIレジスタに書き込まれます。

> `mov`はmoveの省略形ですが、実際にはデータを移動するわけではなく単にコピーする命令です。

- `call`と`ret`はセット
	- `call`: 関数を呼び出す命令
		- `call`の次の命令（この場合`ret`）のアドレスをスタックにプッシュ
		- `call`の引数として与えられたアドレスにジャンプ
	- `ret`: 呼び出し元の関数の実行を再開する命令
		- スタックからアドレスを1つポップ
		- そのアドレスにジャンプ

### オンライン・コンパイラ
- [Compiler Explorer](https://godbolt.org/)
> Compiler Explorerで画面の左半分のテキストボックスにコードを入力すると、右半分にそれに対応するアセンブリ出力がリアルタイムに表示されます。Cコードがどのようなアセンブリに変換されるのか確認したいときはこのサイトを使うのがよいでしょう。


